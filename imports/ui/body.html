<body>
  <div class="ui fluid container">
    <div class="ui grid">
      <div class="one wide column"></div>
      <div class="fourteen wide column">
        <h2 class="ui header">
        <img class="ui image" src="https://www.bekaert.com//-/media/Images/ADMIN/Logos/Bekaert-Logo/Logo-bekaert-better-together-CYAN-RGB1.JPG?h=220&w=532">
        <div class="big content">
          Bekaert Lipetsk trucks logistics
        </div>
        </h2>
      </div>
    </div>
    <div class="ui grid">
      <div class="one wide column"></div>
      <div class="one wide column">
        {{> loginButtons}}
      </div>
      <div class="twelve wide column">
        <div class="ui top attached tabular menu">
          {{#if isInRole 'add-shipments'}}
          <a class="item" data-tab="new-shipment">Add new <div class="ui green circular label">+</div></a>
          {{/if}}
          <a class="item active" data-tab="shipment-ontheway">On the way<div class="ui teal circular label">{{count_ontheway}}</div></a>
          <a class="item" data-tab="shipment-arrived">Arrived<div class="ui blue circular label">{{count_arrived}}</div></a>
          <a class="item" data-tab="shipment-entered">Waiting loading / unloading<div class="ui violet circular label">{{count_entered}}</div></a>
          <a class="item" data-tab="shipment-released">Waiting documents<div class="ui purple  circular label">{{count_released}}</div></a>
          <a class="item" data-tab="shipment-leaving">Leaving<div class="ui pink circular label">{{count_leaving}}</div></a>
          <a class="item" data-tab="shipment-archived">Archive</a>
        </div>
        <!-- Form for created but not arrived shipments    -->
        
        {{#if isInRole 'add-shipments'}}
        <div class="ui bottom attached tab segment" data-tab="new-shipment">
          {{> shipmentDetails button_add=1}}
        </div>
        {{/if}}
        <!--  -->
        <div class="ui bottom attached tab segment active" data-tab="shipment-ontheway">
          {{> truckTable header="Trucks on the way" shipments=shipments_created actions=(availableActions 'ontheway') }}
        </div>
        <!-- Form for arrived shipments    -->
        <div class="ui bottom attached tab segment" data-tab="shipment-arrived">
          {{> truckTable header="Arrived trucks" shipments=shipments_arrived actions=(availableActions 'arrived')}}
        </div>
        <!-- Form for entered trucks    -->
        <div class="ui bottom attached tab segment" data-tab="shipment-entered">
          {{> truckTable header="Trucks waiting loading" shipments=shipments_waiting_loading actions=(availableActions 'waiting_loading')}}
          {{> truckTable header="Trucks waiting unloading" shipments=shipments_waiting_unloading actions=(availableActions 'waiting_unloading')}}
        </div>
        <!-- Form for entered trucks    -->
        <div class="ui bottom attached tab segment" data-tab="shipment-released">
          {{> truckTable header="Drivers waiting TC docs" shipments=shipments_waiting_docs_TC actions=(availableActions 'released')}}
          {{> truckTable header="Drivers waiting DRX docs" shipments=shipments_waiting_docs_DRX actions=(availableActions 'released')}}
        </div>
        <div class="ui bottom attached tab segment" data-tab="shipment-leaving">
          {{> truckTable header="Trucks leaving the plant" shipments=shipments_leaving actions=(availableActions 'leaving')}}
        </div>
        <div class="ui bottom attached tab segment" data-tab="shipment-archived">
          {{> truckTable header="Archived shipments" shipments=shipments_archived}}
        </div>
      </div>
    </div>
  </div>
</body>
<!--  -->
<!--  -->
<!-- template for each table -->
<template name="truckTable">
<table class="ui table  ">
  <thead>
    <tr >
      <th colspan=6>
        <div class="ui big label">{{header}}</div>
      </th>
    </tr>
    <tr>
      <th><i class="ui attach icon"></i></th>
      <th>Type</th>
      <th>Plate</th>
      <th>Driver</th>
      <th>Comment</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {{> shipmentsList}}
    <!--
      TODO: add grouping per expected arrival
    {{> groupedShipmentsList groups=(selectUnique shipments 'expected_arrival_time') groupBy='expected_arrival_time' groupByText="Expected arrival date: "}}
    -->
  </tbody>
</table>
</template>
<!--  -->
<!--  -->
<!-- Template with list of shipments -->
<template name="groupedShipmentsList">
{{#each group in groups}}
<tr>
  <td colspan="6">{{groupByText}}{{group}}</td>
</tr>
{{> shipmentsList shipments=(filterShipments shipments groupBy group)}}
{{/each}}
</template>
<!--  -->
<!--  -->
<!-- Template with list of shipments -->
<template name="shipmentsList">
{{#each shipments}}
<tr>
  {{> shipment}}
  <td align="left">
    {{#each action in ../actions}}
    {{#if isAllowed action}}
    <button class="shipment-action ui small {{#if isDangerous action}}red{{else}}green{{/if}} button" data={{action}}><i class="checkmark box icon"></i>Mark {{action}}</button>
    {{/if}}
    {{/each}}

  </td>
</tr>
{{else}}
<tr><td>No trucks here!</td></tr>
{{/each}}
</template>
<!--  -->
<!--  -->
<!-- Template for each truck -->
<template name="shipment">
<td class="openShipment">
  {{#if attached_files}}
  <i class="ui attach icon"></i>
  {{/if}}
</td>
<td class="openShipment" data={{_id}}>{{shipment_type}}</td>
<td class="openShipment" data={{_id}}>{{truck_plate}}</td>
<td class="openShipment" data={{_id}}>{{driver_name}}</td>
<td class="openShipment" data={{_id}}>{{text}}</td>
<div id={{_id}} class="ui modal">
  <div class="content">
    {{> shipmentDetails show_history=1}}
  </div>
  <div class="actions">
    <div class="ui button cancel">Cancel</div>
    <!-- <div class="ui button ok">OK</div> -->
  </div>
</div>
</template>
<!--  -->
<!--  -->
<!-- template for details of shipment -->
<template name="shipmentDetails">
<div class="ui grid">
  <div class="{{#if show_history}}eight{{else}}sixteen{{/if}} wide column">
    <form class="new-shipment ui form">
      <div class="field">
        <select class="ui search dropdown" name="sh_type" value={{shipment_type}}>
          <option value="">Select...</option>
          <option value="WR">Wire rod</option>
          <option value="ISC_container">ISC in container</option>
          <option value="TC_truck">Tire cord in truck</option>
          <option value="TC_container">Tire cord in container</option>
          <option value="DRX_truck">Dramix in truck</option>
          <option value="DRX_container">Dramix in container</option>
          <option value="Other">Other</option>
        </select></div>
        <br>
        <div class="field"><div class="ui labeled fluid input"><div class="ui label">Plate:</div><input class="ui input" type="text" name="plate" placeholder="Type  here..." value={{../truck_plate}} /></div></div>
        <br>
        <div class="field"><div class="ui labeled fluid input"><div class="ui label">Driver:</div><input class="ui input" type="text" name="driver" placeholder="Type  here..." value={{../driver_name}} /></div></div>
        <br>
        <div class="field"><div class="ui labeled input"><div class="ui label">Comment:</div><input class="ui input" type="text" name="text" placeholder="Type  here..." value={{../text}} /></div></div>
        <br>
        <div class="field">
          <div class="ui labeled input">
            <div class="ui label">Expected arrival:</div>
            <div class="ui calendar" id="expected_arrival_datepicker">
              <div class="ui input left icon">
                <i class="calendar icon"></i>
                <input type="text" placeholder="Date/Time" name="expected_arrival_time" value={{../expected_arrival_time}}>
              </div>
            </div>
          </div>
        </div>
        <br>
        {{#if show_history}}
        {{#if ../attached_files}}
        {{> fileList files=(selectImages ../attached_files)}}
        {{/if}}
        {{/if}}
        
        {{#if button_add}}
        {{> uploadForm}}
        <button class="ui big green button" type="submit"><i class="save icon"></i>Add</button>
        {{/if}}
      </form>
    </div>
    {{#if show_history}}
    {{#with ../history}}
    <div class="eight wide column">
      <table class="ui table">
        <thead>
          <tr>
            <th>action</th>
            <th>time</th>
            <th>user</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>created</td>
            <td>{{created.time}}{{#unless created.time}}-{{/unless}}</td>
            <td>{{created.user}}{{#unless created.user}}-{{/unless}}</td>
          </tr>
          <tr>
            <td>arrived</td>
            <td>{{arrived.time}}{{#unless arrived.time}}-{{/unless}}</td>
            <td>{{arrived.user}}{{#unless arrived.user}}-{{/unless}}</td>
          </tr>
          <tr>
            <td>entered</td>
            <td>{{entered.time}}{{#unless entered.time}}-{{/unless}}</td>
            <td>{{entered.user}}{{#unless entered.user}}-{{/unless}}</td>
          </tr>
          <tr>
            <td>loaded</td>
            <td>{{loaded.time}}{{#unless loaded.time}}-{{/unless}}</td>
            <td>{{loaded.user}}{{#unless loaded.user}}-{{/unless}}</td>
          </tr>
          <tr>
            <td>unloaded</td>
            <td>{{unloaded.time}}{{#unless unloaded.time}}-{{/unless}}</td>
            <td>{{unloaded.user}}{{#unless unloaded.user}}-{{/unless}}</td>
          </tr>
          <tr>
            <td>documented</td>
            <td>{{documented.time}}{{#unless documented.time}}-{{/unless}}</td>
            <td>{{documented.user}}{{#unless documented.user}}-{{/unless}}</td>
          </tr>
          <tr>
            <td>left</td>
            <td>{{left.time}}{{#unless left.time}}-{{/unless}}</td>
            <td>{{left.user}}{{#unless left.user}}-{{/unless}}</td>
          </tr>
        </tbody>
      </table>
    </div>
    {{/with}}
    {{/if}}
  </div>
  </template>
  <!--  -->
  <!--  -->
  <!-- template to upload files -->
  <template name="uploadForm">
  {{> fileList files=(selectImages tempUploaded.list)}}
  {{#with currentUpload}}
  Uploading <b>{{file.name}}</b>:
  <span id="progress">{{progress.get}}%</span>
  {{else}}
  <div class="field"><div class="ui labeled fluid input"><div class="ui label">Attach:</div><input id="fileInput" type="file" /></div></div>
  {{/with}}
  </template>
  <!--  -->
  <!--  -->
  <!-- tmplate to show list of links to uploaded files -->
  <template name="fileList">
  <div class="ui list">
    {{#each file in files}}
    <div class="item">
      <i class="ui image icon"></i>
      <div class="content">
        <a href={{file.path}}>{{file.name}}</a>
      </div>
    </div>
    <img class="ui small image" src={{fileURL file}}>
    {{/each}}
  </div>
  <input type="hidden" name="attached_files" value="{{#each file in files}} {{file._id}}{{/each}}" />
  </template>